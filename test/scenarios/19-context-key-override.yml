# Test: Context key override at test level
# Demonstrates that test-level context entries override scenario-level entries
# when they have the same ContextKeyName

policy_json: "../policies/allow-s3-with-conditions.json"

# Scenario-level context: default trusted IP
context:
  - ContextKeyName: "aws:SourceIp"
    ContextKeyType: "string"
    ContextKeyValues: ["10.0.1.50"]

tests:
  - name: "GetObject uses scenario context (trusted IP)"
    action: "s3:GetObject"
    resource: "arn:aws:s3:::secure-bucket/data.txt"
    # No test-level context = uses scenario context
    expect: "allowed"

  - name: "GetObject with overridden IP (untrusted)"
    action: "s3:GetObject"
    resource: "arn:aws:s3:::secure-bucket/data.txt"
    context:
      - ContextKeyName: "aws:SourceIp"
        ContextKeyType: "string"
        ContextKeyValues: ["192.168.1.1"]  # OVERRIDES scenario IP
    expect: "implicitDeny"

  - name: "DeleteObject with MFA added (keeps scenario IP)"
    action: "s3:DeleteObject"
    resource: "arn:aws:s3:::secure-bucket/data.txt"
    context:
      - ContextKeyName: "aws:MultiFactorAuthPresent"
        ContextKeyType: "boolean"
        ContextKeyValues: ["true"]  # ADDS new key, doesn't override IP
    expect: "allowed"  # Should have both trusted IP and MFA=true

  - name: "DeleteObject with MFA but overridden untrusted IP"
    action: "s3:DeleteObject"
    resource: "arn:aws:s3:::secure-bucket/data.txt"
    context:
      - ContextKeyName: "aws:SourceIp"
        ContextKeyType: "string"
        ContextKeyValues: ["192.168.1.1"]  # OVERRIDES to untrusted
      - ContextKeyName: "aws:MultiFactorAuthPresent"
        ContextKeyType: "boolean"
        ContextKeyValues: ["true"]  # ADDS MFA
    expect: "allowed"  # MFA statement allows DeleteObject without IP restriction

  - name: "PutObject with overridden untrusted IP fails"
    action: "s3:PutObject"
    resource: "arn:aws:s3:::secure-bucket/upload.txt"
    context:
      - ContextKeyName: "aws:SourceIp"
        ContextKeyType: "string"
        ContextKeyValues: ["192.168.1.1"]  # OVERRIDES to untrusted
    expect: "implicitDeny"  # PutObject requires trusted IP
